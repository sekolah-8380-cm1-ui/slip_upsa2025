<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slip Keputusan UPSA 2025 – Edit & Cetak</title>
<style>
  :root{
    --warm-border:#8b4513; --warm-header:#deb887; --warm-row:#fff7e6; --title:#6d3b10; --text:#222;
  }
  *{box-sizing:border-box}
  body{font-family:"Segoe UI", Calibri, Arial, sans-serif; background:#fffaf0; color:var(--text); margin:0; padding:16px;}
  .wrap{max-width:1100px; margin:0 auto;}
  .toolbar, .logo-actions{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin-bottom:12px;
  }
  input[type="text"], input[type="number"], select, button{
    font-size:15px; padding:8px 10px; border:2px solid var(--warm-border); border-radius:10px; background:#fff; min-height:40px;
  }
  button{cursor:pointer}
  button.primary{ background:var(--warm-border); color:#fff }
  button.ghost{ background:#fffaf0 }
  .logo-bar{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-bottom:8px;}
  .logo-bar img{ height:70px; width:auto; border-radius:8px; border:2px solid var(--warm-border); background:#fff; object-fit:contain; }
  .slip{ background:#fff; padding:20px; border:4px solid var(--warm-border); border-radius:18px; box-shadow:0 6px 18px rgba(139,69,19,.12); }
  .header{text-align:center; margin-bottom:6px;}
  .header h1{font-size:22px; margin:8px 0 0; color:var(--title); text-transform:uppercase; letter-spacing:.5px;}
  .header h2{font-size:18px; margin:6px 0 0; color:var(--title); text-transform:uppercase; letter-spacing:.5px;}
  .meta{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:12px 0 8px;}
  .meta .card{ border:2px solid var(--warm-border); border-radius:12px; padding:10px 12px; background:#fffaf0; }
  .meta b{color:#4a2a0f}
  table{width:100%; border-collapse:collapse; margin-top:6px; table-layout:fixed;}
  th, td{border:2px solid var(--warm-border); padding:8px 10px; text-align:center; word-wrap:break-word;}
  th{background:var(--warm-header); font-size:15px;}
  tbody tr:nth-child(even){ background:var(--warm-row) }
  tfoot th{ background:#f3d4a5 }
  .summary{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:12px 0; }
  .summary .box{ border:2px solid var(--warm-border); border-radius:12px; padding:10px; background:#fffaf0; text-align:center; font-size:16px; font-weight:600; }
  .ulasan{ border:2px dashed var(--warm-border); border-radius:12px; padding:12px; background:#fffdf4; margin-top:6px; }
  .sign{ display:flex; justify-content:space-between; gap:16px; margin-top:18px; flex-wrap:wrap; }
  .sign .line{min-width:260px}
  .sign .line::after{ content:""; display:block; border-bottom:1.5px solid #333; margin-top:50px; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px;}
  .panel{ border:2px solid var(--warm-border); border-radius:12px; padding:12px; background:#fff; }
  .panel h3{ margin:0 0 8px 0; color:var(--title); font-size:16px; }
  .form-row{ display:grid; grid-template-columns: 1.1fr 1.1fr .8fr; gap:8px; align-items:center; margin:6px 0;}
  .form-row input, .form-row select{ width:100% }
  .danger{ border-color:#b3261e; color:#b3261e }
  .ok{ border-color:#2b7a0b; color:#2b7a0b }
  .muted{ color:#6d3b10; font-size:12px }
  @media print{
    body{ background:#fff; padding:0 }
    .toolbar, .logo-actions, .grid2{ display:none }
    .wrap{ max-width:none; margin:0 }
    .slip{ border-width:2px; box-shadow:none; border-radius:0; page-break-after:always }
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- LOGO -->
  <div class="logo-bar">
    <img id="logo" alt="Logo Sekolah" src="" style="display:none" />
  </div>
  <div class="logo-actions">
    <input id="logoFile" type="file" accept="image/*" />
    <button onclick="uploadLogo()">Muat Naik Logo</button>
    <button class="ghost" onclick="clearLogo()">Padam Logo</button>
  </div>

  <!-- TOOLS -->
  <div class="toolbar">
    <label for="kelasSel">Kelas:</label>
    <select id="kelasSel"></select>

    <label for="studentSel">Murid:</label>
    <select id="studentSel" style="min-width:260px"></select>

    <input id="search" type="text" list="names" placeholder="Cari nama murid..." style="min-width:260px" />
    <datalist id="names"></datalist>

    <button class="primary" onclick="window.print()">Cetak / Simpan PDF</button>
    <button class="ghost" id="downloadPdfBtn">Muat Turun PDF Individu</button>
    <button class="ghost" id="recalcBtn">Recalculate Kedudukan</button>
    <button class="ghost" id="exportBtn">Export JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none">
    <button class="ghost" id="importBtn">Import JSON</button>
  </div>

  <!-- PAPARAN SLIP -->
  <div id="slip" class="slip">
    <div class="header">
      <h1>SEKOLAH KEBANGSAAN KORAN, SERIAN</h1>
      <h2>Pencapaian Keseluruhan Ujian Pertengahan Sesi Akademik (UPSA) 2025</h2>
    </div>

    <div class="meta">
      <div class="card"><b>Nama Murid:</b> <span id="nama">-</span></div>
      <div class="card"><b>Kelas:</b> <span id="kelas">5 Gemilang</span></div>
    </div>

    <table id="markTable">
      <thead>
        <tr>
          <th style="width:55%">Mata Pelajaran</th>
          <th style="width:22%">Markah</th>
          <th style="width:23%">Gred</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th>Jumlah Markah</th>
          <th id="jumlah">-</th>
          <th id="kedudukan">Kedudukan: -</th>
        </tr>
      </tfoot>
    </table>

    <div class="summary">
      <div class="box">Jumlah: <span id="sumBox">-</span></div>
      <div class="box">Kedudukan Dalam Kelas: <span id="rankBox">-</span></div>
    </div>

    <div class="ulasan" id="ulasan">Ulasan Guru: —</div>

    <div class="sign">
      <div class="line">Tandatangan Guru Kelas</div>
      <div class="line">Tandatangan Guru Besar</div>
    </div>

    <div class="muted" style="text-align:center;margin-top:6px">
      Tip: Selepas ubah markah/gred, klik <b>Simpan Perubahan</b>. Gunakan <b>Recalculate Kedudukan</b> untuk kira semula kedudukan seluruh kelas.
    </div>
  </div>

  <!-- EDITOR -->
  <div class="grid2">
    <div class="panel">
      <h3>Edit Murid Terpilih</h3>
      <div class="form-row">
        <input id="nameInput" type="text" placeholder="Nama murid">
        <input id="classInput" type="text" placeholder="Nama kelas">
        <input id="rankInput" type="number" placeholder="Kedudukan">
      </div>
      <div class="form-row">
        <input id="totalInput" type="number" placeholder="Jumlah (auto)" disabled>
        <select id="autoGradeSwitch">
          <option value="on">Gred Auto (ikut markah)</option>
          <option value="off">Gred Manual</option>
        </select>
        <div></div>
      </div>
      <div id="subjectForm"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="primary" id="saveBtn">Simpan Perubahan</button>
        <button class="ghost" id="resetBtn">Reset ke Data Asal</button>
        <button class="danger" id="deleteBtn" style="border:2px solid #b3261e;background:#fff;color:#b3261e">Padam Murid</button>
      </div>
    </div>

    <div class="panel">
      <h3>Urus Kelas</h3>
      <div class="form-row">
        <input id="newName" type="text" placeholder="Nama murid baharu">
        <select id="templateSel">
          <option value="kosong">Markah kosong</option>
          <option value="purata">Auto isian purata (50 – gred C)</option>
        </select>
        <button id="addBtn">Tambah Murid</button>
      </div>
      <div class="muted">
        • <b>Export JSON</b> → muat turun data (backup).<br>
        • <b>Import JSON</b> → muat naik data untuk gantikan/kemas kini.<br>
        • Data custom & logo disimpan secara tempatan (LocalStorage pelayar).
      </div>
    </div>
  </div>
</div>

<!-- html2pdf bundle (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
/* ========= KONFIG & DATA ========= */
const SUBJECTS = [
  ["Bahasa Melayu","BM"],
  ["Bahasa Inggeris","BI"],
  ["Matematik","MT"],
  ["Sains","SN"],
  ["Sejarah","SEJ"],
  ["Pendidikan Jasmani & Kesihatan","PJPK"],
  ["Pendidikan Moral/Islam","PMPI"],
  ["Reka Bentuk & Teknologi","RBT"],
  ["Pendidikan Seni Visual","PSV"],
  ["Pendidikan Muzik","PMZ"],
];

function autoGrade(mark){
  if(mark===null || mark==="" || isNaN(mark)) return "";
  mark = Number(mark);
  if(mark>=85) return "A";
  if(mark>=70) return "B";
  if(mark>=55) return "C";
  if(mark>=40) return "D";
  if(mark>=1)  return "E";
  if(mark===0) return "F";
  return "";
}

/* Ulasan ringkas & padat */
function genUlasanRingkas(s){
  const key2label = Object.fromEntries(SUBJECTS.map(([l,k])=>[k,l]));
  const m = s.m;
  const total = calcTotal(m);
  const rank = Number(s.rank)||null;

  // kategori ringkas ikut total
  let ringkas = (total>=600) ? "Cemerlang keseluruhan." :
               (total>=450) ? "Baik dan konsisten." :
               (total>=350) ? "Sederhana; masih ruang diperbaiki." :
                              "Perlu bimbingan rapi.";

  // subjek cemerlang (A) & lemah (E/F/TH atau markah<40)
  const cemerlang = [];
  const lemah = [];
  for(const [k,[mark, g]] of Object.entries(m)){
    const label = key2label[k] || k;
    const gg = (g && g.trim()) ? g.trim().toUpperCase() : autoGrade(mark);
    if(gg==="A") cemerlang.push(label);
    if(gg==="E" || gg==="F" || gg==="TH" || (Number(mark)||0)<40) lemah.push(label);
  }

  const parts = [];
  parts.push(ringkas);
  if(rank && rank<=3) parts.push("Top 3 kelas.");
  if(cemerlang.length>=2) parts.push("Kuat: " + cemerlang.slice(0,3).join(", ") + ".");
  if(lemah.length>=2) parts.push("Fokus: " + lemah.slice(0,3).join(", ") + ".");
  if(parts.length===1 && cemerlang.length) parts.push("Kuat: " + cemerlang.slice(0,3).join(", ") + ".");
  return "Ulasan Guru: " + parts.join(" ");
}

const DATA_ORIGIN = [{
  kelas: "5 Gemilang",
  murid: [
    { name:"ALDRIN ANAK WEREN SILVER", total:400, rank:11,
      m:{BM:[38,"D"], BI:[20,"E"], MT:[40,"D"], SN:[40,"D"], SEJ:[38,"D"], PJPK:[56,"C"], PMPI:[78,"B"], RBT:[33,"E"], PSV:[24,"E"], PMZ:[33,"E"]} },
    { name:"ALLYCIA SHYNTIA ANAK SUREMI", total:438, rank:8,
      m:{BM:[0,"F"], BI:[12,"F"], MT:[36,"D"], SN:[40,"D"], SEJ:[54,"C"], PJPK:[54,"C"], PMPI:[64,"C"], RBT:[49,"D"], PSV:[76,"B"], PMZ:[53,"C"]} },
    { name:"ANDREN VALENTINO ANAK ANDY", total:421, rank:9,
      m:{BM:[0,"F"], BI:[38,"D"], MT:[8,"F"], SN:[68,"B"], SEJ:[0,"F"], PJPK:[70,"B"], PMPI:[58,"C"], RBT:[46,"D"], PSV:[86,"A"], PMZ:[47,"D"]} },
    { name:"ARIEYANNA HETTY ANAK BOESTAMAN", total:478, rank:6,
      m:{BM:[54,"C"], BI:[20,"E"], MT:[12,"F"], SN:[60,"C"], SEJ:[62,"C"], PJPK:[58,"C"], PMPI:[64,"C"], RBT:[35,"D"], PSV:[66,"B"], PMZ:[47,"D"]} },
    { name:"AARON ANAK NANCY", total:386, rank:12,
      m:{BM:[56,"C"], BI:[22,"E"], MT:[40,"D"], SN:[20,"E"], SEJ:[58,"C"], PJPK:[44,"D"], PMPI:[26,"E"], RBT:[29,"E"], PSV:[58,"C"], PMZ:[33,"E"]} },
    { name:"ASHLEY JOANNE ANAK AJ DILLON", total:640, rank:2,
      m:{BM:[40,"D"], BI:[54,"C"], MT:[46,"D"], SN:[82,"A"], SEJ:[80,"B"], PJPK:[60,"C"], PMPI:[56,"C"], RBT:[52,"C"], PSV:[84,"A"], PMZ:[86,"A"]} },
    { name:"CRIST THOMPSON ANAK DUSTINE", total:220, rank:17,
      m:{BM:[0,"F"], BI:[18,"F"], MT:[0,"F"], SN:[28,"E"], SEJ:[0,"F"], PJPK:[44,"D"], PMPI:[24,"E"], RBT:[25,"E"], PSV:[68,"B"], PMZ:[13,"F"]} },
    { name:"DAREL JOANS ANAK BRANDEN", total:459, rank:7,
      m:{BM:[34,"E"], BI:[24,"E"], MT:[32,"E"], SN:[32,"E"], SEJ:[54,"C"], PJPK:[62,"C"], PMPI:[54,"C"], RBT:[46,"D"], PSV:[74,"B"], PMZ:[47,"D"]} },
    { name:"DELWINA LARA CHEW", total:706, rank:1,
      m:{BM:[66,"B"], BI:[72,"B"], MT:[88,"A"], SN:[80,"B"], SEJ:[46,"D"], PJPK:[82,"A"], PMPI:[80,"B"], RBT:[53,"C"], PSV:[72,"B"], PMZ:[67,"B"]} },
    { name:"GLORIA ANAK ROKIN", total:263, rank:16,
      m:{BM:[0,"F"], BI:[16,"F"], MT:[4,"F"], SN:[20,"E"], SEJ:[0,"F"], PJPK:[42,"D"], PMPI:[56,"C"], RBT:[24,"E"], PSV:[68,"B"], PMZ:[33,"E"]} },
    { name:"GRACESILLA ANAK LARRY", total:483, rank:5,
      m:{BM:[54,"C"], BI:[34,"E"], MT:[56,"C"], SN:[42,"D"], SEJ:[52,"C"], PJPK:[46,"D"], PMPI:[64,"C"], RBT:[25,"E"], PSV:[70,"B"], PMZ:[40,"D"]} },
    { name:"JAVIERS MELSELM ANAK DOMINIC", total:508, rank:4,
      m:{BM:[0,"F"], BI:[34,"E"], MT:[32,"E"], SN:[60,"C"], SEJ:[68,"B"], PJPK:[74,"B"], PMPI:[70,"B"], RBT:[45,"D"], PSV:[72,"B"], PMZ:[53,"C"]} },
    { name:"JOSEPH JONG", total:120, rank:18,
      m:{BM:[0,"F"], BI:[12,"F"], MT:[8,"F"], SN:[12,"F"], SEJ:[0,"F"], PJPK:[12,"F"], PMPI:[30,"E"], RBT:[0,"F"], PSV:[46,"D"], PMZ:[0,"TH"]} },
    { name:"KAIREN WELL JR WELFRED", total:357, rank:13,
      m:{BM:[0,"F"], BI:[26,"E"], MT:[8,"F"], SN:[46,"D"], SEJ:[0,"F"], PJPK:[54,"C"], PMPI:[64,"C"], RBT:[34,"E"], PSV:[72,"B"], PMZ:[53,"C"]} },
    { name:"LAVENDER ANAK LIZA", total:528, rank:3,
      m:{BM:[64,"C"], BI:[22,"E"], MT:[56,"C"], SN:[44,"D"], SEJ:[78,"B"], PJPK:[50,"C"], PMPI:[42,"D"], RBT:[44,"D"], PSV:[68,"B"], PMZ:[60,"C"]} },
    { name:"LUKE PHILLSTEVE ANAK LUCAS", total:345, rank:14,
      m:{BM:[0,"F"], BI:[16,"F"], MT:[28,"E"], SN:[30,"E"], SEJ:[40,"D"], PJPK:[38,"D"], PMPI:[40,"D"], RBT:[37,"D"], PSV:[56,"C"], PMZ:[60,"C"]} },
    { name:"NEYMAR ANAK FRANKEY", total:270, rank:15,
      m:{BM:[0,"F"], BI:[12,"F"], MT:[8,"F"], SN:[20,"E"], SEJ:[0,"F"], PJPK:[42,"D"], PMPI:[40,"D"], RBT:[23,"E"], PSV:[72,"B"], PMZ:[53,"C"]} },
    { name:"PHALLENOS MARVIN TAN", total:418, rank:10,
      m:{BM:[54,"C"], BI:[22,"E"], MT:[24,"E"], SN:[38,"D"], SEJ:[38,"D"], PJPK:[58,"C"], PMPI:[54,"C"], RBT:[29,"E"], PSV:[68,"B"], PMZ:[33,"E"]} },
  ]
}];

const LS_KEY = "upsa_data_custom_v2";
const LS_LOGO = "upsa_logo_base64";
function loadData(){ const raw = localStorage.getItem(LS_KEY); if(!raw) return JSON.parse(JSON.stringify(DATA_ORIGIN)); try{ return JSON.parse(raw); }catch{ return JSON.parse(JSON.stringify(DATA_ORIGIN)); } }
function saveData(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

/* Logo handling */
const logoImg = document.getElementById('logo');
const logoFileInput = document.getElementById('logoFile');
function loadSavedLogo(){ const saved = localStorage.getItem(LS_LOGO); if(saved){ logoImg.src = saved; logoImg.style.display = 'inline-block'; } }
function uploadLogo(){
  const f = logoFileInput.files?.[0];
  if(!f) return alert("Sila pilih fail logo terlebih dahulu.");
  const reader = new FileReader();
  reader.onload = () => { logoImg.src = reader.result; logoImg.style.display = 'inline-block'; localStorage.setItem(LS_LOGO, reader.result); alert("Logo dimuat naik & disimpan."); };
  reader.readAsDataURL(f);
}
function clearLogo(){ localStorage.removeItem(LS_LOGO); logoImg.removeAttribute('src'); logoImg.style.display = 'none'; }

/* UI refs */
const kelasSel = document.getElementById('kelasSel');
const studentSel = document.getElementById('studentSel');
const searchInput = document.getElementById('search');
const namesDL = document.getElementById('names');
const namaEl = document.getElementById('nama');
const kelasEl = document.getElementById('kelas');
const tbody = document.querySelector('#markTable tbody');
const jumlahEl = document.getElementById('jumlah');
const kedudukanEl = document.getElementById('kedudukan');
const sumBox = document.getElementById('sumBox');
const rankBox = document.getElementById('rankBox');
const ulasanEl = document.getElementById('ulasan');

const nameInput = document.getElementById('nameInput');
const classInput = document.getElementById('classInput');
const totalInput = document.getElementById('totalInput');
const rankInput = document.getElementById('rankInput');
const autoGradeSwitch = document.getElementById('autoGradeSwitch');
const subjectForm = document.getElementById('subjectForm');

const addBtn = document.getElementById('addBtn');
const newName = document.getElementById('newName');
const templateSel = document.getElementById('templateSel');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const deleteBtn = document.getElementById('deleteBtn');
const recalcBtn = document.getElementById('recalcBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');

let DATA = loadData();
let kelasIdx = 0;
let muridIdx = 0;

/* Helpers */
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
function calcTotal(mobj){ return SUBJECTS.reduce((sum,[_,key])=>{ const val = mobj[key]?.[0]; return sum + (isFinite(val)? Number(val):0); },0); }
function fillSubjectForm(mobj){
  subjectForm.innerHTML = "";
  SUBJECTS.forEach(([label,key])=>{
    const [mark, grade] = mobj[key] ?? ["",""];
    const row = document.createElement('div');
    row.className = 'form-row';
    row.innerHTML = `
      <input type="text" value="${label}" disabled>
      <input type="number" min="0" max="100" step="1" data-key="${key}" class="mark-input" placeholder="Markah" value="${mark!==""?mark:""}">
      <input type="text" maxlength="3" data-gkey="${key}" class="grade-input" placeholder="Gred (kosong=auto)" value="${grade!==""?grade:""}" title="Biarkan kosong untuk auto-grade">
    `;
    subjectForm.appendChild(row);
  });
}

function renderSlip(){
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  if(!s) return;

  // pastikan total selari
  s.total = calcTotal(s.m);

  namaEl.textContent = s.name;
  kelasEl.textContent = kls.kelas;
  tbody.innerHTML = "";

  SUBJECTS.forEach(([label,key])=>{
    const [mark, gradeManual] = s.m[key] ?? ["",""];
    const finalGrade = (autoGradeSwitch.value==="on" || !gradeManual || gradeManual.trim()==="")
      ? autoGrade(mark)
      : gradeManual.toUpperCase();
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${label}</td><td>${mark!==""?mark:""}</td><td>${finalGrade||""}</td>`;
    tbody.appendChild(tr);
  });

  jumlahEl.textContent = s.total;
  sumBox.textContent = s.total;
  kedudukanEl.textContent = "Kedudukan: " + (s.rank ?? "-");
  rankBox.textContent = s.rank ?? "-";

  // Ulasan ringkas
  ulasanEl.textContent = genUlasanRingkas(s);

  // Editor
  nameInput.value = s.name;
  classInput.value = kls.kelas;
  rankInput.value = s.rank ?? "";
  totalInput.value = s.total;

  fillSubjectForm(s.m);
  populateStudentDropdown();
  studentSel.value = String(muridIdx);
}

function populateKelasDropdown(){
  kelasSel.innerHTML = "";
  DATA.forEach((k, i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = k.kelas;
    kelasSel.appendChild(opt);
  });
  kelasSel.value = String(kelasIdx);
}
function populateStudentDropdown(){
  const list = DATA[kelasIdx].murid;
  studentSel.innerHTML = "";
  namesDL.innerHTML = "";
  list.forEach((s,i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = s.name;
    studentSel.appendChild(opt);
    const o2 = document.createElement('option');
    o2.value = s.name; namesDL.appendChild(o2);
  });
}
function recalcRanks(){
  const list = DATA[kelasIdx].murid;
  list.forEach(s => s.total = calcTotal(s.m));
  const sorted = list.map((s,i)=>({s, i})).sort((a,b)=>b.s.total - a.s.total);
  let currentRank = 1, prevTotal = null, counter = 0;
  sorted.forEach(({s})=>{
    counter++;
    if(prevTotal===null || s.total < prevTotal){ currentRank = counter; prevTotal = s.total; }
    s.rank = currentRank;
  });
}

/* Events */
kelasSel.addEventListener('change', ()=>{ kelasIdx = +kelasSel.value || 0; muridIdx = 0; renderSlip(); });
studentSel.addEventListener('change', ()=>{ muridIdx = +studentSel.value || 0; renderSlip(); });
searchInput.addEventListener('change', ()=>{
  const term = searchInput.value.trim().toLowerCase();
  const idx = DATA[kelasIdx].murid.findIndex(s=>s.name.toLowerCase()===term);
  if(idx>=0){ muridIdx = idx; renderSlip(); }
});

saveBtn.addEventListener('click', ()=>{
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];

  // kemas kini nama & kelas & rank
  const newName = nameInput.value.trim();
  if(newName) s.name = newName;
  const newClass = classInput.value.trim();
  if(newClass) kls.kelas = newClass;
  s.rank = rankInput.value ? Number(rankInput.value) : s.rank;

  // markah & gred
  const markInputs = subjectForm.querySelectorAll('.mark-input');
  markInputs.forEach(inp=>{
    const key = inp.dataset.key;
    let val = inp.value === "" ? "" : Math.max(0, Math.min(100, Number(inp.value)));
    const gradeInp = subjectForm.querySelector(`.grade-input[data-gkey="${key}"]`);
    let g = gradeInp.value.trim().toUpperCase();
    if(autoGradeSwitch.value==="on") g = ""; // paksa auto jika switch ON
    s.m[key] = [val, g];
  });

  s.total = calcTotal(s.m);
  saveData(DATA);
  populateKelasDropdown(); // untuk pantul perubahan nama kelas
  renderSlip();
  alert("Perubahan disimpan ke peranti (LocalStorage).");
});

resetBtn.addEventListener('click', ()=>{
  if(!confirm("Reset kelas ini ke data asal? Perubahan tersimpan akan hilang.")) return;
  const asal = deepClone(DATA_ORIGIN[kelasIdx]);
  DATA[kelasIdx] = asal;
  saveData(DATA);
  renderSlip();
});

deleteBtn.addEventListener('click', ()=>{
  if(!confirm("Padam murid ini?")) return;
  DATA[kelasIdx].murid.splice(muridIdx, 1);
  muridIdx = 0;
  saveData(DATA);
  renderSlip();
});

addBtn.addEventListener('click', ()=>{
  const n = newName.value.trim();
  if(!n){ alert("Sila isi nama murid baharu."); return; }
  const tmpl = templateSel.value;
  const m = {};
  SUBJECTS.forEach(([_,key])=>{
    if(tmpl==="purata"){ m[key] = [50,""]; } else { m[key] = ["",""]; }
  });
  DATA[kelasIdx].murid.push({ name:n, total:calcTotal(m), rank:null, m });
  newName.value = "";
  saveData(DATA);
  muridIdx = DATA[kelasIdx].murid.length-1;
  renderSlip();
});

recalcBtn.addEventListener('click', ()=>{
  recalcRanks();
  saveData(DATA);
  renderSlip();
  alert("Kedudukan dikira semula berdasarkan jumlah markah semasa.");
});

exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DATA,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "UPSA-Data.json";
  a.click();
  URL.revokeObjectURL(a.href);
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const imported = JSON.parse(reader.result);
      if(!Array.isArray(imported)) throw new Error("Struktur tidak sah.");
      DATA = imported;
      saveData(DATA);
      kelasIdx = 0; muridIdx = 0;
      populateKelasDropdown(); populateStudentDropdown(); renderSlip();
      alert("Import berjaya.");
    }catch(err){ alert("Gagal import: " + err.message); }
  };
  reader.readAsText(f);
});

/* ====== Download PDF individu dengan logo ====== */
function sanitizeFilename(name){
  return name.replace(/[^A-Za-z0-9\s\-]/g, '').trim().replace(/\s+/g, '_');
}
function downloadPdf(){
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  if(!s) return alert("Tiada murid terpilih.");

  // pastikan logo (jika ada) telah dimuat
  const element = document.getElementById('slip');
  const imgs = element.querySelectorAll('img');
  let promises = [];
  imgs.forEach(img => {
    if(!img.src) return;
    if(img.complete) return;
    promises.push(new Promise((res)=>{ img.onload = img.onerror = res; }));
  });

  const namePart = sanitizeFilename(s.name).toUpperCase();
  const filename = `${namePart}-UPSA2025.pdf`;
  const opt = {
    margin:       [10, 10, 10, 10],
    filename:     filename,
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true, logging: false },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  Promise.all(promises).then(()=>{
    html2pdf().set(opt).from(element).save().catch(err => {
      console.error(err); alert("Gagal muat turun PDF: " + err.message);
    });
  });
}
downloadPdfBtn.addEventListener('click', downloadPdf);

/* Init */
function init(){
  populateKelasDropdown();
  populateStudentDropdown();
  renderSlip();
  loadSavedLogo();
}
init();
</script>
</body>
</html>